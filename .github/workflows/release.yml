name: AutoTestSystem - Release (net472)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  SOLUTION_FILE: AutoTestSystem.sln
  PROJECT_FILE: AutoTestSystem/AutoTestSystem.csproj
  BUILD_CONFIGURATION: Release

jobs:
  build_and_release:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        shell: pwsh
        run: nuget restore "${{ env.SOLUTION_FILE }}" -NonInteractive

      - name: Build (Release -> out) with platform auto-detect
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $proj = "${{ env.PROJECT_FILE }}"
          $cfg  = "${{ env.BUILD_CONFIGURATION }}"

          if (-not (Test-Path $proj)) {
            throw "找不到 PROJECT_FILE：$proj（請確認 AutoTestSystem/AutoTestSystem.csproj 路徑）"
          }

          # 讀 csproj，抓出該 Configuration 下有哪些 Platform（AnyCPU / Any CPU / x86 / x64）
          $xml = Get-Content $proj -Raw

          # 解析條件： '$(Configuration)|$(Platform)' == 'Release|x86' 之類
          $rx = "['""]\s*\$\(\s*Configuration\s*\)\|\$\(\s*Platform\s*\)\s*['""]\s*==\s*['""]$cfg\|([^'""]+)['""]"
          $matches = [regex]::Matches($xml, $rx)
          $platforms = @()
          foreach ($m in $matches) { $platforms += $m.Groups[1].Value }
          $platforms = $platforms | Select-Object -Unique

          if (-not $platforms -or $platforms.Count -eq 0) {
            $platforms = @("AnyCPU","Any CPU","x86","x64")
          }

          $pref = @("AnyCPU","Any CPU","x86","x64")
          $plat = ($pref | Where-Object { $platforms -contains $_ } | Select-Object -First 1)
          if (-not $plat) { $plat = $platforms[0] }

          Write-Host ("Detected platforms for {0}: {1}" -f $cfg, ($platforms -join ", "))
          Write-Host ("Using platform: {0}" -f $plat)

          $out = Join-Path $env:GITHUB_WORKSPACE "out\"
          New-Item -ItemType Directory -Force -Path $out | Out-Null
