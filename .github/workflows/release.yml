name: AutoTestSystem - Release (net472)

on:
  push:
    tags:
      - "v*"
      - "V*"
  workflow_dispatch:

permissions:
  contents: write

env:
  SOLUTION_FILE: AutoTestSystem.sln
  PROJECT_FILE: AutoTestSystem/AutoTestSystem.csproj
  BUILD_CONFIGURATION: Release

jobs:
  build_and_release:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        shell: pwsh
        run: nuget restore "${{ env.SOLUTION_FILE }}" -NonInteractive

      - name: Build to out\
        id: build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $proj = "${{ env.PROJECT_FILE }}"
          $cfg  = "${{ env.BUILD_CONFIGURATION }}"

          if (-not (Test-Path $proj)) {
            throw "找不到 PROJECT_FILE：$proj"
          }

          # 讀 csproj，抓出該 Configuration 下有哪些 Platform
          $xml = Get-Content $proj -Raw
          $rx  = "Condition\s*=\s*""\s*'\$\(\s*Configuration\s*\)\|\$\(\s*Platform\s*\)'\s*==\s*'$cfg\|([^']+)'\s*"""
          $platforms = [regex]::Matches($xml, $rx) | ForEach-Object { $_.Groups[1].Value } | Select-Object -Unique

          if (-not $platforms -or $platforms.Count -eq 0) {
            $platforms = @("AnyCPU","Any CPU","x86","x64")
          }

          $pref = @("AnyCPU","Any CPU","x86","x64")
          $plat = ($pref | Where-Object { $platforms -contains $_ } | Select-Object -First 1)
          if (-not $plat) { $plat = $platforms[0] }

          Write-Host ("Detected platforms for {0}: {1}" -f $cfg, ($platforms -join ", "))
          Write-Host ("Using platform: {0}" -f $plat)

          $out = Join-Path $env:GITHUB_WORKSPACE "out\"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          # 真的去編譯（重點：這段一定要存在）
          msbuild $proj /m `
            /p:Configuration="$cfg" `
            /p:Platform="$plat" `
            /p:BaseOutputPath="$out" `
            /p:OutputPath="$out" `
            /p:OutDir="$out"

          # 驗證 exe 是否存在（不存在就直接 fail，避免「看起來成功但其實沒產物」）
          $exe = Get-ChildItem -Path $out -Recurse -Filter "AutoTestSystem.exe" | Select-Object -First 1
          if (-not $exe) {
            Write-Host "=== out\ listing ==="
            Get-ChildItem -Path $out -Recurse | Select-Object FullName
            throw "Build 完成但找不到 AutoTestSystem.exe（請確認 AssemblyName / OutputType / 專案啟動專案是否正確）"
          }
          Write-Host ("Found EXE: {0}" -f $exe.FullName)

      - name: Package zip
        id: pack
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $zipName = "AutoTestSystem-${{ github.ref_name }}.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }

          Compress-Archive -Path "out\*" -DestinationPath $zipName -Force
          Write-Host ("Created: {0}" -f $zipName)

          "zip=$zipName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload artifact (Actions)
        uses: actions/upload-artifact@v4
        with:
          name: AutoTestSystem-${{ github.ref_name }}
          path: ${{ steps.pack.outputs.zip }}

      - name: Upload Release Asset (only tags)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.pack.outputs.zip }}
