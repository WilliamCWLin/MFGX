name: AutoTestSystem - Release (net472)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  SOLUTION_FILE: AutoTestSystem.sln
  PROJECT_FILE: AutoTestSystem/AutoTestSystem.csproj
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: "Any CPU"   # 若你專案是 x86，改成 "x86"

jobs:
  build_and_release:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        shell: pwsh
        run: nuget restore "${{ env.SOLUTION_FILE }}" -NonInteractive

      - name: Build (Release -> out)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $out = Join-Path $env:GITHUB_WORKSPACE "out\"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          # 直接 build 專案，並指定 OutDir，避免輸出散落在 bin\Release/x86\Release 等各種路徑
          msbuild "${{ env.PROJECT_FILE }}" /m `
            /p:Configuration="${{ env.BUILD_CONFIGURATION }}" `
            /p:Platform="${{ env.BUILD_PLATFORM }}" `
            /p:OutDir="$out"

      - name: Verify output
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "=== out directory listing ==="
          Get-ChildItem "$env:GITHUB_WORKSPACE\out" -Force | Format-Table Name, Length

          if (-not (Test-Path "$env:GITHUB_WORKSPACE\out\AutoTestSystem.exe")) {
            Write-Host "=== Found EXEs under out ==="
            Get-ChildItem "$env:GITHUB_WORKSPACE\out" -Recurse -Filter "*.exe" | Select-Object -First 50 FullName
            throw "out\AutoTestSystem.exe 不存在。請確認 AutoTestSystem.csproj 的 <AssemblyName> 是否不是 AutoTestSystem，或輸出類型/平台設定不同。"
          }

      - name: Package (zip)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $zipName = "AutoTestSystem-${{ github.ref_name }}.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path "$env:GITHUB_WORKSPACE\out\*" -DestinationPath $zipName -Force
          Write-Host "Created: $zipName"

      - name: Upload artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: AutoTestSystem-${{ github.ref_name }}
          path: AutoTestSystem-${{ github.ref_name }}.zip

      - name: Create GitHub Release + upload asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: AutoTestSystem-${{ github.ref_name }}.zip
