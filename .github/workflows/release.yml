name: AutoTestSystem - Release (net472)

on:
  push:
    tags:
      - "v*"
      - "V*"
  workflow_dispatch:

permissions:
  contents: write

env:
  SOLUTION_FILE: AutoTestSystem.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: "Any CPU"   # 若你專案是 x86，改成 "x86"

jobs:
  build_and_release:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        shell: pwsh
        run: nuget restore "${{ env.SOLUTION_FILE }}" -NonInteractive

      # ====== 新增：Tag 版本寫入 AssemblyInfo.cs（只在 tag 觸發時執行）======
      - name: Stamp version from tag (AssemblyVersion / FileVersion)
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # 支援 v / V 開頭，且必須是 4 碼數字版本：v3.0.0.6
          $ver = "${{ github.ref_name }}" -replace '^[vV]', ''

          if ($ver -notmatch '^\d+\.\d+\.\d+\.\d+$') {
            throw "Tag 版本必須是 4 碼：v3.0.0.6 這種格式。你目前是：${{ github.ref_name }}"
          }

          $asm = "AutoTestSystem\Properties\AssemblyInfo.cs"
          if (-not (Test-Path $asm)) {
            throw "找不到 $asm（請確認 AssemblyInfo.cs 路徑）"
          }

          $c = Get-Content $asm -Raw

          if ($c -notmatch 'AssemblyVersion\(".*?"\)') {
            throw "$asm 內找不到 [assembly: AssemblyVersion(""..."")]"
          }
          if ($c -notmatch 'AssemblyFileVersion\(".*?"\)') {
            throw "$asm 內找不到 [assembly: AssemblyFileVersion(""..."")]"
          }

          $c = [regex]::Replace($c, 'AssemblyVersion\(".*?"\)', "AssemblyVersion(`"$ver`")")
          $c = [regex]::Replace($c, 'AssemblyFileVersion\(".*?"\)', "AssemblyFileVersion(`"$ver`")")

          Set-Content -Path $asm -Value $c -Encoding UTF8

          Write-Host "Stamped AssemblyVersion / AssemblyFileVersion => $ver"
      # ===================================================================

      - name: Build (Release)
        shell: pwsh
        run: msbuild "${{ env.SOLUTION_FILE }}" /m /p:Configuration="${{ env.BUILD_CONFIGURATION }}" /p:Platform="${{ env.BUILD_PLATFORM }}"

      - name: Package (zip)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # 1) 在整個 repo 內找 AutoTestSystem.exe
          #    排除常見不可能的路徑，避免找到奇怪的中介檔
          $exe = Get-ChildItem -Path . -Recurse -File -Filter "AutoTestSystem.exe" -ErrorAction SilentlyContinue |
                 Where-Object {
                   $_.FullName -notmatch "\\obj\\|\\\.vs\\|\\packages\\|\\TestResults\\|\\bin\\Debug\\"
                 } |
                 Sort-Object LastWriteTime -Descending |
                 Select-Object -First 1

          if (-not $exe) {
            Write-Host "=== 找不到 AutoTestSystem.exe，列出所有 bin 目錄供診斷 ==="
            Get-ChildItem -Path . -Recurse -Directory -ErrorAction SilentlyContinue |
              Where-Object { $_.FullName -match "\\bin\\" } |
              Select-Object -First 50 FullName
            throw "找不到 AutoTestSystem.exe。請先確認 Build step 是否真的有產生 exe（或 AssemblyName 是否不同）。"
          }

          $srcDir = Split-Path $exe.FullName -Parent
          Write-Host "Packaging from: $srcDir"
          Write-Host "EXE: $($exe.FullName)"

          # 2) 複製該輸出資料夾到 dist（避免壓到多餘檔案）
          if (Test-Path dist) { Remove-Item dist -Recurse -Force }
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item -Recurse -Force "$srcDir\*" dist\

          # 3) 產生 zip
          $zipName = "AutoTestSystem-${{ github.ref_name }}.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path dist\* -DestinationPath $zipName -Force

          Write-Host "Created: $zipName"

      - name: Create GitHub Release + upload asset
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: AutoTestSystem-${{ github.ref_name }}.zip
