name: AutoTestSystem - Release (net472)

on:
  push:
    tags:
      - "v*"
      - "V*"	  
  workflow_dispatch:

# 讓 GITHUB_TOKEN 有建立 Release / 上傳資產權限
permissions:
  contents: write

env:
  SOLUTION_FILE: AutoTestSystem.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: "Any CPU"   # 若你專案是 x86，改成 "x86"

jobs:
  build_and_release:
    runs-on: windows-2022  # 建議固定版本，避免 windows-latest 映像更新造成不穩定 :contentReference[oaicite:0]{index=0}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2  # 把 msbuild 加到 PATH :contentReference[oaicite:1]{index=1}

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2        # 讓 nuget.exe 可用 :contentReference[oaicite:2]{index=2}

      - name: Restore NuGet packages
        shell: pwsh
        run: nuget restore "${{ env.SOLUTION_FILE }}" -NonInteractive

      - name: Build (Release)
        shell: pwsh
        run: msbuild "${{ env.SOLUTION_FILE }}" /m /p:Configuration="${{ env.BUILD_CONFIGURATION }}" /p:Platform="${{ env.BUILD_PLATFORM }}"

      - name: Package (zip)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # 1) 在整個 repo 內找 AutoTestSystem.exe
          #    排除常見不可能的路徑，避免找到奇怪的中介檔
          $exe = Get-ChildItem -Path . -Recurse -File -Filter "AutoTestSystem.exe" -ErrorAction SilentlyContinue |
                 Where-Object {
                   $_.FullName -notmatch "\\obj\\|\\\.vs\\|\\packages\\|\\TestResults\\|\\bin\\Debug\\"
                 } |
                 Sort-Object LastWriteTime -Descending |
                 Select-Object -First 1

          if (-not $exe) {
            Write-Host "=== 找不到 AutoTestSystem.exe，列出所有 bin 目錄供診斷 ==="
            Get-ChildItem -Path . -Recurse -Directory -ErrorAction SilentlyContinue |
              Where-Object { $_.FullName -match "\\bin\\" } |
              Select-Object -First 50 FullName
            throw "找不到 AutoTestSystem.exe。請先確認 Build step 是否真的有產生 exe（或 AssemblyName 是否不同）。"
          }

          $srcDir = Split-Path $exe.FullName -Parent
          Write-Host "Packaging from: $srcDir"
          Write-Host "EXE: $($exe.FullName)"

          # 2) 複製該輸出資料夾到 dist（避免壓到多餘檔案）
          if (Test-Path dist) { Remove-Item dist -Recurse -Force }
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item -Recurse -Force "$srcDir\*" dist\

          # 3) 產生 zip
          $zipName = "AutoTestSystem-${{ github.ref_name }}.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path dist\* -DestinationPath $zipName -Force

          Write-Host "Created: $zipName"


      - name: Create GitHub Release + upload asset
        uses: softprops/action-gh-release@v2
        with:
          files: AutoTestSystem-${{ github.ref_name }}.zip
